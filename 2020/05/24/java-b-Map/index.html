<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>java-b-Map | Alex</title><meta name="description" content="java-b-Map"><meta name="keywords" content="java,code"><meta name="author" content="Alex"><meta name="copyright" content="Alex"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin="crossorigin"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="twitter:card" content="summary"><meta name="twitter:title" content="java-b-Map"><meta name="twitter:description" content="java-b-Map"><meta name="twitter:image" content="https://herycs.github.io/img/post.jpg"><meta property="og:type" content="article"><meta property="og:title" content="java-b-Map"><meta property="og:url" content="https://herycs.github.io/2020/05/24/java-b-Map/"><meta property="og:site_name" content="Alex"><meta property="og:description" content="java-b-Map"><meta property="og:image" content="https://herycs.github.io/img/post.jpg"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>var autoChangeMode = 'false'
var t = Cookies.get("theme")
if (autoChangeMode == '1'){
  var isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
  var isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
  var isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
  var hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined){
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport){
      console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
      var now = new Date()
      var hour = now.getHours()
      var isNight = hour < 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
  }
  } else if (t == 'light') activateLightMode()
  else activateDarkMode()

} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="canonical" href="https://herycs.github.io/2020/05/24/java-b-Map/"><link rel="prev" title="linux-sw-docker" href="https://herycs.github.io/2020/05/24/linux-sw-docker/"><link rel="next" title="ds-b-Tree.md" href="https://herycs.github.io/2020/05/21/ds-b-Tree/"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://xxx/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  bookmark: {
    message_prev: 'Press',
    message_next: 'to bookmark this page'
  },
  runtime_unit: 'days',
  runtime: true,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: undefined,
  baiduPush: false,
  highlightCopy: true,
  highlightLang: true,
  highlightShrink: 'false',
  isFontAwesomeV5: false,
  isPhotoFigcaption: false
  
}</script><script>var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isSidebar: true  
  }</script><noscript><style>
#page-header {
  opacity: 1
}
.justified-gallery img{
  opacity: 1
}
</style></noscript><meta name="generator" content="Hexo 4.2.0"></head><body><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">Articles</div><div class="length_num">28</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">Tags</div><div class="length_num">16</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">Categories</div><div class="length_num">7</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> About</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> List</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/documents"><i class="fa-fw fa fa-music"></i><span> Documents</span></a></li></ul></div></div></div></div><i class="fa fa-arrow-right on" id="toggle-sidebar" aria-hidden="true">     </i><div id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#HashMap"><span class="toc-number">1.</span> <span class="toc-text">HashMap</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#概览"><span class="toc-number">1.1.</span> <span class="toc-text">概览</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#jdk1-7"><span class="toc-number">1.1.1.</span> <span class="toc-text">jdk1.7</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#put流程"><span class="toc-number">1.1.1.1.</span> <span class="toc-text">put流程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#冲突"><span class="toc-number">1.1.1.2.</span> <span class="toc-text">冲突</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#扩容"><span class="toc-number">1.1.1.3.</span> <span class="toc-text">扩容</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#死锁"><span class="toc-number">1.1.1.4.</span> <span class="toc-text">死锁</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#jdk1-8"><span class="toc-number">1.1.2.</span> <span class="toc-text">jdk1.8</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#put流程-1"><span class="toc-number">1.1.2.1.</span> <span class="toc-text">put流程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#冲突-1"><span class="toc-number">1.1.2.2.</span> <span class="toc-text">冲突</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#扩容-1"><span class="toc-number">1.1.2.3.</span> <span class="toc-text">扩容</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#源码定义"><span class="toc-number">1.2.</span> <span class="toc-text">源码定义</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#结构"><span class="toc-number">1.2.1.</span> <span class="toc-text">结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#内部常量"><span class="toc-number">1.2.2.</span> <span class="toc-text">内部常量</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Hash值"><span class="toc-number">1.3.</span> <span class="toc-text">Hash值</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#TablesSizeFor"><span class="toc-number">1.4.</span> <span class="toc-text">TablesSizeFor</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#字段"><span class="toc-number">1.5.</span> <span class="toc-text">字段</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#查找结点"><span class="toc-number">1.6.</span> <span class="toc-text">查找结点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#扩容-2"><span class="toc-number">1.7.</span> <span class="toc-text">扩容</span></a></li></ol></li></ol></div></div></div><div id="body-wrap"><div class="post-bg" id="nav" style="background-image: url(/img/post.jpg)"><div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">Alex</a></span><span class="pull_right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> About</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> List</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/documents"><i class="fa-fw fa fa-music"></i><span> Documents</span></a></li></ul></div></div><span class="toggle-menu close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span></span></div><div id="post-info"><div id="post-title"><div class="posttitle">java-b-Map</div></div><div id="post-meta"><div class="meta-firstline"><time class="post-meta__date"><span class="post-meta__date-created" title="Created 2020-05-24 21:59:40"><i class="fa fa-calendar" aria-hidden="true"></i> Created 2020-05-24</span><span class="post-meta__separator">|</span><span class="post-meta__date-updated" title="Updated 2020-05-24 21:59:40"><i class="fa fa-history" aria-hidden="true"></i> Updated 2020-05-24</span></time><span class="post-meta__categories"><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/java/">java</a></span></div><div class="meta-secondline"> </div><div class="meta-thirdline"><span class="post-meta-pv-cv"><i class="fa fa-eye post-meta__icon" aria-hidden="true"> </i><span>Post View:</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-commentcount"></span></div></div></div></div><main class="layout_post" id="content-inner"><article id="post"><div id="article-container"><h1 id="HashMap"><a href="#HashMap" class="headerlink" title="HashMap"></a>HashMap</h1><h2 id="概览"><a href="#概览" class="headerlink" title="概览"></a>概览</h2><h3 id="jdk1-7"><a href="#jdk1-7" class="headerlink" title="jdk1.7"></a>jdk1.7</h3><p>jdk1.7中的实现：数组加链表</p>
<h4 id="put流程"><a href="#put流程" class="headerlink" title="put流程"></a>put流程</h4><ol>
<li><p>通过对key进行hash()得到其唯一散列值</p>
</li>
<li><p>将其key映射到数组中，对散列值取余（hash &amp; (length-1)）length为数组长度，自此存储完成</p>
<ul>
<li><p>和length-1做&amp;运算，length一定是一个2^N，N是整数</p>
<p>  举例：length = 16 {0001 0000}，这是length-1 = {0000 1111}，这和hash做&amp;运算相当于取了低四位，正好对应0-15的数组索引</p>
<p>  当然为了让这个运算结果更加的分散均匀，让高位的通过位移也参与到运算过程中，增加了数据的散列程度</p>
</li>
</ul>
</li>
</ol>
<p>1.7的hash方法</p>
<blockquote>
<p>考：<a href="https://www.iteye.com/topic/709945" target="_blank" rel="noopener">ITeye</a></p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//这种写法使得有一位一旦有变化就会引发整个值的改动</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">hash</span><span class="params">(<span class="keyword">int</span> h)</span> </span>&#123;</span><br><span class="line">    h ^= (h &gt;&gt;&gt; <span class="number">20</span>) ^ (h &gt;&gt;&gt; <span class="number">12</span>);</span><br><span class="line">    <span class="keyword">return</span> h ^ (h &gt;&gt;&gt; <span class="number">7</span>) ^ (h &gt;&gt;&gt; <span class="number">4</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>算法中是采用(h&gt;&gt;&gt;7)而不是(h&gt;&gt;&gt;8)的算法，应该是考虑1、2、3三位出现重复位^运算的情况。</p>
<p>使得最<strong>低位上原hashCode的8位都参与了^运算</strong>，所以在table.length为默认值16的情况下面，hashCode任意位的变化基本都能反应到最终hash table 定位算法中</p>
<h4 id="冲突"><a href="#冲突" class="headerlink" title="冲突"></a>冲突</h4><ul>
<li><p>发生原因：冲突是由于hash()计算后得到的要存储在的数组位置已有了元素，同时达到了超过扩容阈值</p>
</li>
<li><p>处理办法：</p>
<ul>
<li><p>流程：这时就会形成链表，具体操作就是使用头插法（认为新插入的会被先用到），类似挂砝码，旧的挂到新的下面，新的挂到秤杆（元素组）上</p>
<p><img src="/" class="lazyload" data-src="https://img-blog.csdnimg.cn/20200609155017565.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQyMDcwMTc5,size_16,color_FFFFFF,t_70"  alt="在这里插入图片描述"></p>
</li>
<li><p>采用原因：若使用尾插，则当链表的长度比较长的时候会导致检索时间过长，从而影响效率</p>
</li>
</ul>
</li>
</ul>
<h4 id="扩容"><a href="#扩容" class="headerlink" title="扩容"></a>扩容</h4><ul>
<li><p>发生原因：Map中的节点数量达到了扩容阈值，[当前容量*负载因子]</p>
</li>
<li><p>处理办法：</p>
<ul>
<li><p>流程：先扩容（申请2倍容量的数据），然后数据迁移</p>
<ul>
<li><p>拷贝：拷贝的方式是基于已有hash值再次定位，定位方式是：hash &amp; (length-1)），此处的length是新的数组长度</p>
<p>  例子：length = 32 {0010 0000}，length-1 = 31 {0001 1111}相对于扩容前可以看到用于进行数据切割的位数多了一位</p>
<p>  这时在进行hash &amp; (length-1)只有两个结果：</p>
<ol>
<li><p>运算结果高位增加1（数值增加16）</p>
<p> 例如：原来在index = 2，这时在第二个数组的索引2处也就是（index = 16 + 2 = 18）</p>
</li>
<li><p>运算结果高位增加一个0（也就是不变）</p>
<p> 例如：原来在index = 2，此时任然在index = 2的位置</p>
</li>
</ol>
</li>
</ul>
</li>
</ul>
</li>
<li><p>结果：相对于原链表，扩容后节点顺序会改变，假定扩容前后a,b,c都在同一个位置，则：原链表：a-&gt;b-&gt;c，扩容后：c-&gt;b-&gt;a</p>
<ul>
<li>原因：扩容是从数组所指向的节点开始依次遍历，所以最开始被移动到新数组的是最靠近数组的节点，而插入方法是头插法</li>
</ul>
</li>
</ul>
<h4 id="死锁"><a href="#死锁" class="headerlink" title="死锁"></a>死锁</h4><ul>
<li><p>在多线程环境下可能执行put()会导致死锁</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">transfer</span><span class="params">(Entry[] newTable, <span class="keyword">boolean</span> rehash)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> newCapacity = newTable.length;</span><br><span class="line">    <span class="keyword">for</span> (Entry&lt;K,V&gt; e : table) &#123;</span><br><span class="line">        <span class="keyword">while</span>(<span class="keyword">null</span> != e) &#123;</span><br><span class="line">            Entry&lt;K,V&gt; next = e.next;</span><br><span class="line">            <span class="keyword">if</span> (rehash) &#123;</span><br><span class="line">                e.hash = <span class="keyword">null</span> == e.key ? <span class="number">0</span> : hash(e.key);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">int</span> i = indexFor(e.hash, newCapacity);</span><br><span class="line">            <span class="comment">//这两步是成环的关键</span></span><br><span class="line">            e.next = newTable[i];</span><br><span class="line">            newTable[i] = e;</span><br><span class="line">            e = next;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>发生流程，操作HashMap此时达到阈值，需要扩容（节点不动，修改指针）：</p>
<p>  ​    原情况：</p>
<p>  <img src="/" class="lazyload" data-src="https://img-blog.csdnimg.cn/20200609164505144.png"  alt="在这里插入图片描述"></p>
<ol>
<li><p>线程A操作：将a,b记录，e-&gt;Node2, next-&gt;Node1，时间片结束</p>
</li>
<li><p>线程B操作：a,b扩容后，此时的顺序是table[i] = Node1，Node1.next = Node2，操作结束或者时间片到了</p>
<p> <img src="/" class="lazyload" data-src="https://img-blog.csdnimg.cn/20200609164542939.png"  alt="在这里插入图片描述"></p>
</li>
<li><p>线程A操作：e.next = table[i] {此处就是 Node2.next = table[i] = Node1}，好到此为止，关系Node1&lt;=&gt;Node2建立</p>
<p> <img src="/" class="lazyload" data-src="https://img-blog.csdnimg.cn/20200609165447592.png"  alt="在这里插入图片描述"></p>
</li>
</ol>
</li>
</ul>
<h3 id="jdk1-8"><a href="#jdk1-8" class="headerlink" title="jdk1.8"></a>jdk1.8</h3><p>实现：数组 + 链表 | 红黑树（&gt;=阈值时修改结构，默认8）</p>
<h4 id="put流程-1"><a href="#put流程-1" class="headerlink" title="put流程"></a>put流程</h4><ol>
<li><p>对key进行hash()若为null,得到的值将会是0，计算索引索引任然是hash &amp; (length -1)</p>
<blockquote>
<p>源码中的hash()方法，除了调用Object的hash方法，还与hash高16位进行了与运算</p>
</blockquote>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">hash</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> h;</span><br><span class="line">    <span class="keyword">return</span> (key == <span class="keyword">null</span>) ? <span class="number">0</span> : (h = key.hashCode()) ^ (h &gt;&gt;&gt; <span class="number">16</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>放置节点</p>
</li>
</ol>
<h4 id="冲突-1"><a href="#冲突-1" class="headerlink" title="冲突"></a>冲突</h4><ul>
<li><p>发生原因：同上</p>
</li>
<li><p>处理策略：尾插法，若链表节点个数[&gt;=8]，对当前table[i]数据结构进行修改，结构改为红黑树（选红黑树的原因此处暂不讨论）</p>
<ul>
<li><p>此处有一点：TreeNode比普通Node大一点（所以在不非常影响性能情况下，尽可能晚点使用树结构）</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//普通节点</span></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Node</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; <span class="keyword">implements</span> <span class="title">Map</span>.<span class="title">Entry</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> hash;</span><br><span class="line">    <span class="keyword">final</span> K key;</span><br><span class="line">    V value;</span><br><span class="line">    Node&lt;K,V&gt; next;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//TreeNode 大小大概是[2 * 普通节点空间]</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">TreeNode</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; <span class="keyword">extends</span> <span class="title">LinkedHashMap</span>.<span class="title">Entry</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; </span>&#123;</span><br><span class="line">    TreeNode&lt;K,V&gt; parent;  <span class="comment">// red-black tree links</span></span><br><span class="line">    TreeNode&lt;K,V&gt; left;</span><br><span class="line">    TreeNode&lt;K,V&gt; right;</span><br><span class="line">    TreeNode&lt;K,V&gt; prev;    <span class="comment">// needed to unlink next upon deletion</span></span><br><span class="line">    <span class="keyword">boolean</span> red;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
</li>
</ul>
<h4 id="扩容-1"><a href="#扩容-1" class="headerlink" title="扩容"></a>扩容</h4><ul>
<li><p>发生原因：当数据节点达到超过阈值</p>
</li>
<li><p>流程：</p>
<ol>
<li><p>先插入值</p>
</li>
<li><p>扩容</p>
<p> 扩容处理，2倍容量，链表分类（一个是仍然在原相对位置的链表，一个是需要迁移到新位置的链表）</p>
<p> 对于节点是否需要迁移，经过1.7的扩容对比可以发现新位置相当于与原位置是否迁移取决于高位的值是1还是0</p>
<p> 1.8中直接对此位置bit进行判断以决定节点存储位置</p>
<p> 需要</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> Node&lt;K,V&gt;[] resize() &#123;</span><br><span class="line">    <span class="comment">//...省略其他代码</span></span><br><span class="line">    <span class="keyword">if</span> ( (e.hash &amp; oldCap) == <span class="number">0</span>)&#123;</span><br><span class="line">        newIndex = oldIndex;<span class="comment">//此处不是源码的抽象实现只为了表示简单，实际代码可参见源码</span></span><br><span class="line">    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">        newIndex = oldIndex + oldCap;<span class="comment">//此处不是源码的抽象实现只为了表示简单</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//...省略其他代码</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>节点迁移</p>
<p> 将两个分类好的链表头分别放置到新table[]中</p>
</li>
</ol>
</li>
<li><p>结果：数据顺序不变</p>
</li>
</ul>
<h2 id="源码定义"><a href="#源码定义" class="headerlink" title="源码定义"></a>源码定义</h2><blockquote>
<p>1.8</p>
</blockquote>
<h3 id="结构"><a href="#结构" class="headerlink" title="结构"></a>结构</h3><p>继承: AbstractMap</p>
<p>接口：Map&lt;K,V&gt;, Cloneable, Serializable</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HashMap</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; <span class="keyword">extends</span> <span class="title">AbstractMap</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt;</span></span><br><span class="line"><span class="class">    <span class="keyword">implements</span> <span class="title">Map</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt;, <span class="title">Cloneable</span>, <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="内部常量"><a href="#内部常量" class="headerlink" title="内部常量"></a>内部常量</h3><p>序列化ID</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">362498820763181265L</span></span><br></pre></td></tr></table></figure>

<p>其他限制常量</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//默认初始容量</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_INITIAL_CAPACITY = <span class="number">1</span> &lt;&lt; <span class="number">4</span>; <span class="comment">// aka 16</span></span><br><span class="line"><span class="comment">//最大容量</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MAXIMUM_CAPACITY = <span class="number">1</span> &lt;&lt; <span class="number">30</span>;</span><br><span class="line"><span class="comment">//扩容因子</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">float</span> DEFAULT_LOAD_FACTOR = <span class="number">0.75f</span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * Because TreeNodes are about twice the size of regular nodes, we use them only when bins contain enough nodes to   * warrant use(see TREEIFY_THRESHOLD). </span></span><br><span class="line"><span class="comment">  * And when they become too small (due to removal or resizing) they are converted back to plain bins.  </span></span><br><span class="line"><span class="comment">  * In usages with well-distributed user hashCodes, tree bins are rarely used.</span></span><br><span class="line"><span class="comment">  * Ideally, under random hashCodes, the frequency of nodes in bins follows a Poisson distribution</span></span><br><span class="line"><span class="comment">  * (http://en.wikipedia.org/wiki/Poisson_distribution) with a parameter of about 0.5 on average for the default   	 * resizing threshold of 0.75, although with a large variance because of resizing granularity. </span></span><br><span class="line"><span class="comment">  * Ignoring variance, the expected occurrences of list size k are (exp(-0.5) * pow(0.5, k) /  factorial(k)). </span></span><br><span class="line"><span class="comment">  * The first values are:</span></span><br><span class="line"><span class="comment">  * 0:    0.60653066</span></span><br><span class="line"><span class="comment">  * 1:    0.30326533</span></span><br><span class="line"><span class="comment">  * 2:    0.0758163</span></span><br><span class="line"><span class="comment">  * 3:    0.01263606</span></span><br><span class="line"><span class="comment">  * 4:    0.00157952</span></span><br><span class="line"><span class="comment">  * 5:    0.00015795</span></span><br><span class="line"><span class="comment">  * 6:    0.00001316</span></span><br><span class="line"><span class="comment">  * 7:    0.00000094</span></span><br><span class="line"><span class="comment">  * 8:    0.00000006</span></span><br><span class="line"><span class="comment">  * more: less than 1 in ten million</span></span><br><span class="line"><span class="comment">  * 以上展示了：链表中的节点的个数达到上述数值的概率,链表达到8个结点的概概率是很低的</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="comment">//由链表变为树的阈值</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TREEIFY_THRESHOLD = <span class="number">8</span>;</span><br><span class="line"><span class="comment">//树---&gt;链表，最小收缩检测值，小于[TREEIFY_THRESHOLD]6</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> UNTREEIFY_THRESHOLD = <span class="number">6</span>;</span><br></pre></td></tr></table></figure>

<h2 id="Hash值"><a href="#Hash值" class="headerlink" title="Hash值"></a>Hash值</h2><blockquote>
<p>jdk1.8</p>
</blockquote>
<p><strong>hashCode</strong></p>
<blockquote>
<p>hashCode()是一个native方法</p>
</blockquote>
<p>int类型返回值，理论上可将实现近4亿的映射空间，但内存加载如此多的内存空间负担不小，而且对于小数据量而言没必要使用如此大的空间</p>
<p>应用hashCode的优势</p>
<p>实现对少量数据空间的映射，采用取模的策略，具体实现时采用的是^运算（高效）实现对定量空间的映射</p>
<p><strong>&amp; (length-1)</strong></p>
<p>jdk1.7采用这种操作，实际上是对hash值的低16位数据进行了处理（实际使用时数据量一般个数不到2^16)，故采用这种方式实际上是只利用了低16位</p>
<p>jdk1.8采用 hash &amp; (hash &gt;&gt;&gt; 16)，将高16位得到参与与运算，从而更加增大了数值的随机性</p>
<blockquote>
<p>右移16位：一般使用实际的数量少于[2^16]个，故始终是在以低位的数参与随机运算，右移16位获取到高位，运算结果更加随机</p>
<p>^预算：&amp;，| 会使得结果偏向0或1（&amp;只有1&amp;1=1，|只有 0|0=0，其中得0，1的比率是并不是1:1），故采用^运算可使得结果更加平均</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">hash</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> h;</span><br><span class="line">    <span class="comment">//非空key，hash = [h]^[h&gt;&gt;&gt;16]</span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">      * [h &gt;&gt;&gt; 16]&#123;运算：无符号右移，取出h高16位&#125;</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line">    <span class="keyword">return</span> (key == <span class="keyword">null</span>) ? <span class="number">0</span> : (h = key.hashCode()) ^ (h &gt;&gt;&gt; <span class="number">16</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="TablesSizeFor"><a href="#TablesSizeFor" class="headerlink" title="TablesSizeFor"></a>TablesSizeFor</h2><blockquote>
<p>限制：输出参数不可 [&lt;0] [&gt;MAXMAXIMUM_CAPACITY]</p>
<p>功能：返回大于输入参数且最近的2的整数次幂的数</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">tableSizeFor</span><span class="params">(<span class="keyword">int</span> cap)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> n = cap - <span class="number">1</span>;</span><br><span class="line">    n |= n &gt;&gt;&gt; <span class="number">1</span>;</span><br><span class="line">    n |= n &gt;&gt;&gt; <span class="number">2</span>;</span><br><span class="line">    n |= n &gt;&gt;&gt; <span class="number">4</span>;</span><br><span class="line">    n |= n &gt;&gt;&gt; <span class="number">8</span>;</span><br><span class="line">    n |= n &gt;&gt;&gt; <span class="number">16</span>;</span><br><span class="line">    <span class="keyword">return</span> (n &lt; <span class="number">0</span>) ? <span class="number">1</span> : (n &gt;= MAXIMUM_CAPACITY) ? MAXIMUM_CAPACITY : n + <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="字段"><a href="#字段" class="headerlink" title="字段"></a>字段</h2><p>transient关键字确保其不会被序列化</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">transient</span> Node&lt;K,V&gt;[] table;<span class="comment">// 第一次使用</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">transient</span> Set&lt;Map.Entry&lt;K,V&gt;&gt; entrySet;<span class="comment">//缓存</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">transient</span> <span class="keyword">int</span> size;<span class="comment">// 映射关系总数</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">transient</span> <span class="keyword">int</span> modCount;<span class="comment">//HashMap结构被修改次数</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> threshold;<span class="comment">//下一个要调整大小的大小值（容量*负载系数）。</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">float</span> loadFactor;<span class="comment">//负载因子</span></span><br></pre></td></tr></table></figure>

<h2 id="查找结点"><a href="#查找结点" class="headerlink" title="查找结点"></a>查找结点</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> Node&lt;K, V&gt; <span class="title">getNode</span><span class="params">(<span class="keyword">int</span> hash, Object key)</span> </span>&#123;</span><br><span class="line">    Node&lt;K, V&gt;[] tab;</span><br><span class="line">    Node&lt;K, V&gt; first, e;</span><br><span class="line">    <span class="keyword">int</span> n;</span><br><span class="line">    K k;</span><br><span class="line">    <span class="keyword">if</span> ((tab = table) != <span class="keyword">null</span> &amp;&amp; (n = tab.length) &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">        (first = tab[(n - <span class="number">1</span>) &amp; hash]) != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 表非空，获取其结点</span></span><br><span class="line">        <span class="keyword">if</span> (first.hash == hash &amp;&amp; <span class="comment">// always check first node</span></span><br><span class="line">            ((k = first.key) == key || (key != <span class="keyword">null</span> &amp;&amp; key.equals(k))))</span><br><span class="line">            <span class="comment">//检测第一个结点，是目标则返回，否则，在树里</span></span><br><span class="line">            <span class="keyword">return</span> first;</span><br><span class="line">        <span class="keyword">if</span> ((e = first.next) != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (first <span class="keyword">instanceof</span> TreeNode)</span><br><span class="line">                <span class="comment">//当前节点是树节点类型，则目前此表已演化为树型，调用树节点查找方式</span></span><br><span class="line">                <span class="keyword">return</span> ((TreeNode&lt;K, V&gt;) first).getTreeNode(hash, key);</span><br><span class="line">            <span class="keyword">do</span> &#123;</span><br><span class="line">                <span class="comment">//当前节点不是是树节点类型，则目前此表是链表类型，遍历查找</span></span><br><span class="line">                <span class="keyword">if</span> (e.hash == hash &amp;&amp;</span><br><span class="line">                    ((k = e.key) == key || (key != <span class="keyword">null</span> &amp;&amp; key.equals(k))))</span><br><span class="line">                    <span class="comment">//此处有一点，先比较hash，比较key,equals(方法可能由用户实现，其操作效率不能保证，先比较其hash在一定程度上减少由于equals方法的性能对比较的性能造成较大影响)</span></span><br><span class="line">                    <span class="keyword">return</span> e;</span><br><span class="line">            &#125; <span class="keyword">while</span> ((e = e.next) != <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>容量和阈值的重置</strong></p>
<ol>
<li>原表有值<ol>
<li>容量超过最大容量，阈值设置为Integer.MAX_VALUE</li>
<li>未超过限制，容量阈值均为原来的二倍</li>
</ol>
</li>
<li>原表无值，但阈值大于0，新容量为原阈值</li>
<li>原表无值，阈值为0，则这是第一次初始化，设置初始容量，初始阈值</li>
</ol>
<p><strong>数据迁移</strong></p>
<blockquote>
<p>对于槽为是否变化</p>
<p>1.7重新计算Hash位</p>
<p>1.8 e.hash &amp; oldCap == 0则在原地</p>
</blockquote>
<ol>
<li>旧表非空<ol>
<li>遍历旧表的每个元素<ol>
<li>元素为结点，直接存入新空间（新hash槽为hash&amp;(newCap-1)）</li>
<li>元素为树节点，分解树存入新空间</li>
<li>元素非节点，非树，则为链表<ol>
<li>将原链表中的结点一一取出，并计算hash值，计算方式同上<ol>
<li>计算结果为0，则在原槽<ol>
<li>将结点加入lo链表</li>
</ol>
</li>
<li>结果非0，则在新槽<ol>
<li>将结点加入hi链表</li>
</ol>
</li>
<li>将lo链表头节点放入原槽，hi链表头结点放入新槽（j + oldCap）</li>
</ol>
</li>
</ol>
</li>
</ol>
</li>
<li>遍历旧表，直至结束</li>
</ol>
</li>
</ol>
<h2 id="扩容-2"><a href="#扩容-2" class="headerlink" title="扩容"></a>扩容</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> Node&lt;K, V&gt;[] resize() &#123;</span><br><span class="line">    Node&lt;K, V&gt;[] oldTab = table;</span><br><span class="line">    <span class="keyword">int</span> oldCap = (oldTab == <span class="keyword">null</span>) ? <span class="number">0</span> : oldTab.length;</span><br><span class="line">    <span class="keyword">int</span> oldThr = threshold;</span><br><span class="line">    <span class="keyword">int</span> newCap, newThr = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (oldCap &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">//旧容量大于0</span></span><br><span class="line">        <span class="keyword">if</span> (oldCap &gt;= MAXIMUM_CAPACITY) &#123;</span><br><span class="line">            <span class="comment">//旧容量超过了最大限制容量，重新设置阈值[Integer.MAX_VALUE],返回旧表</span></span><br><span class="line">            threshold = Integer.MAX_VALUE;</span><br><span class="line">            <span class="keyword">return</span> oldTab;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((newCap = oldCap &lt;&lt; <span class="number">1</span>) &lt; MAXIMUM_CAPACITY &amp;&amp;</span><br><span class="line">                   oldCap &gt;= DEFAULT_INITIAL_CAPACITY)</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">                 * 容量未超过限制，同时大于默认初始化的空间值，则证明需要 &#123;扩容&#125;</span></span><br><span class="line"><span class="comment">                 * 新容量 = [原容量*2]</span></span><br><span class="line"><span class="comment">                 * 新阈值 = [原阈值*2]</span></span><br><span class="line"><span class="comment">                 * */</span></span><br><span class="line">            newThr = oldThr &lt;&lt; <span class="number">1</span>; <span class="comment">// double threshold</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (oldThr &gt; <span class="number">0</span>) <span class="comment">// initial capacity was placed in threshold</span></span><br><span class="line">        <span class="comment">//放开容量限制,现容量 = [旧阈值]</span></span><br><span class="line">        newCap = oldThr;</span><br><span class="line">    <span class="keyword">else</span> &#123;               <span class="comment">// zero initial threshold signifies using defaults</span></span><br><span class="line">        newCap = DEFAULT_INITIAL_CAPACITY;</span><br><span class="line">        <span class="comment">//新阈值 = [初始容量*加载因子]</span></span><br><span class="line">        newThr = (<span class="keyword">int</span>) (DEFAULT_LOAD_FACTOR * DEFAULT_INITIAL_CAPACITY);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (newThr == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">float</span> ft = (<span class="keyword">float</span>) newCap * loadFactor;</span><br><span class="line">        newThr = (newCap &lt; MAXIMUM_CAPACITY &amp;&amp; ft &lt; (<span class="keyword">float</span>) MAXIMUM_CAPACITY ?</span><br><span class="line">                  (<span class="keyword">int</span>) ft : Integer.MAX_VALUE);</span><br><span class="line">        <span class="comment">//当前阈值为：[新容量 &amp; ]</span></span><br><span class="line">    &#125;</span><br><span class="line">    threshold = newThr;</span><br><span class="line">    <span class="meta">@SuppressWarnings</span>(&#123;<span class="string">"rawtypes"</span>, <span class="string">"unchecked"</span>&#125;)</span><br><span class="line">    Node&lt;K, V&gt;[] newTab = (Node&lt;K, V&gt;[]) <span class="keyword">new</span> Node[newCap];</span><br><span class="line">    table = newTab;</span><br><span class="line">    <span class="keyword">if</span> (oldTab != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//j = [0,tab.length)</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; oldCap; ++j) &#123;</span><br><span class="line">            Node&lt;K, V&gt; e;</span><br><span class="line">            <span class="keyword">if</span> ((e = oldTab[j]) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">//旧表置空</span></span><br><span class="line">                oldTab[j] = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">if</span> (e.next == <span class="keyword">null</span>)</span><br><span class="line">                    <span class="comment">//只有一个元素</span></span><br><span class="line">                    newTab[e.hash &amp; (newCap - <span class="number">1</span>)] = e;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (e <span class="keyword">instanceof</span> TreeNode)</span><br><span class="line">                    <span class="comment">//当前结构为树型</span></span><br><span class="line">                    ((TreeNode&lt;K, V&gt;) e).split(<span class="keyword">this</span>, newTab, j, oldCap);</span><br><span class="line">                <span class="keyword">else</span> &#123; <span class="comment">// preserve order</span></span><br><span class="line">                    <span class="comment">//非树，非结点则为链表类型</span></span><br><span class="line">                    Node&lt;K, V&gt; loHead = <span class="keyword">null</span>, loTail = <span class="keyword">null</span>;</span><br><span class="line">                    Node&lt;K, V&gt; hiHead = <span class="keyword">null</span>, hiTail = <span class="keyword">null</span>;</span><br><span class="line">                    Node&lt;K, V&gt; next;</span><br><span class="line">                    <span class="comment">/**</span></span><br><span class="line"><span class="comment">                      * 以下运算过程中</span></span><br><span class="line"><span class="comment">                      *      lo链表保存扩容后在原位的结点</span></span><br><span class="line"><span class="comment">                      *      hi链表保存扩容后需要移动位置的结点</span></span><br><span class="line"><span class="comment">                      * */</span></span><br><span class="line">                    <span class="keyword">do</span> &#123;</span><br><span class="line">                        next = e.next;</span><br><span class="line">                        <span class="comment">//链表创建过程：尾插法</span></span><br><span class="line">                        <span class="keyword">if</span> ((e.hash &amp; oldCap) == <span class="number">0</span>) &#123;</span><br><span class="line">                            <span class="comment">/**</span></span><br><span class="line"><span class="comment">                                 * 计算是否需要移动</span></span><br><span class="line"><span class="comment">                                 * [oldCap] = tab.length</span></span><br><span class="line"><span class="comment">                                 * [hash &amp; oldCap] = 0,则在原位</span></span><br><span class="line"><span class="comment">                                 * */</span></span><br><span class="line">                            <span class="keyword">if</span> (loTail == <span class="keyword">null</span>)</span><br><span class="line">                                <span class="comment">// 当前链表为空</span></span><br><span class="line">                                loHead = e;</span><br><span class="line">                            <span class="keyword">else</span></span><br><span class="line">                                loTail.next = e;</span><br><span class="line">                            loTail = e;</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="comment">//[hash &amp; oldCap] != 0,需要移动到新的hash槽</span></span><br><span class="line">                            <span class="keyword">if</span> (hiTail == <span class="keyword">null</span>)</span><br><span class="line">                                hiHead = e;</span><br><span class="line">                            <span class="keyword">else</span></span><br><span class="line">                                hiTail.next = e;</span><br><span class="line">                            hiTail = e;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">while</span> ((e = next) != <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (loTail != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        loTail.next = <span class="keyword">null</span>;</span><br><span class="line">                        newTab[j] = loHead;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (hiTail != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="comment">// 需要挪动的结点移动至新的Hash槽</span></span><br><span class="line">                        hiTail.next = <span class="keyword">null</span>;</span><br><span class="line">                        newTab[j + oldCap] = hiHead;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> newTab;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><a href="https://zhuanlan.zhihu.com/p/55890890" target="_blank" rel="noopener">参考知乎</a></p>
<p><a href="https://www.bbsmax.com/A/kmzLrgXA5G/" target="_blank" rel="noopener">参考个人博客</a></p>
</blockquote>
</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">Alex</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://herycs.github.io/2020/05/24/java-b-Map/">https://herycs.github.io/2020/05/24/java-b-Map/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/java/">java</a><a class="post-meta__tags" href="/tags/code/">code</a></div><div class="post_share"><div class="social-share" data-image="/img/post.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"/><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><nav class="pagination_post" id="pagination"><div class="prev-post pull_left"><a href="/2020/05/24/linux-sw-docker/"><img class="prev_cover lazyload" data-src="/img/post.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">linux-sw-docker</div></div></a></div><div class="next-post pull_right"><a href="/2020/05/21/ds-b-Tree/"><img class="next_cover lazyload" data-src="/img/post.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">ds-b-Tree.md</div></div></a></div></nav><div class="relatedPosts"><div class="relatedPosts_headline"><i class="fa fa-fw fa-thumbs-up" aria-hidden="true"></i><span> Recommend</span></div><div class="relatedPosts_list"><div class="relatedPosts_item"><a href="/2020/06/06/java-a-序列化/" title="java-a-序列化"><img class="relatedPosts_cover lazyload"data-src="/img/post.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-06-06</div><div class="relatedPosts_title">java-a-序列化</div></div></a></div><div class="relatedPosts_item"><a href="/2020/06/07/java-a-并发/" title="java-a-并发"><img class="relatedPosts_cover lazyload"data-src="/img/post.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-06-07</div><div class="relatedPosts_title">java-a-并发</div></div></a></div><div class="relatedPosts_item"><a href="/2018/08/16/java-#-jdbc/" title="java-#-jdbc"><img class="relatedPosts_cover lazyload"data-src="/img/post.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2018-08-16</div><div class="relatedPosts_title">java-#-jdbc</div></div></a></div><div class="relatedPosts_item"><a href="/2020/06/11/java-a-反射-代理-注解-泛型-异常/" title="反射&代理-注解-泛型-异常"><img class="relatedPosts_cover lazyload"data-src="/img/post.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-06-11</div><div class="relatedPosts_title">反射&代理-注解-泛型-异常</div></div></a></div></div><div class="clear_both"></div></div></article></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2020 By Alex</div><div class="framework-info"><span>Driven </span><a href="https://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme </span><a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" rel="noopener"><span>Butterfly</span></a></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="Read Mode"></i><i class="fa fa-plus" id="font_plus" title="Increase font size"></i><i class="fa fa-minus" id="font_minus" title="Decrease font size"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="Traditional Chinese and Simplified Chinese Conversion" target="_self">繁</a><i class="darkmode fa fa-moon-o" id="darkmode" title="Dark Mode"></i></div><div id="rightside-config-show"><div id="rightside_config" title="Setting"><i class="fa fa-cog" aria-hidden="true"></i></div><i class="fa fa-list-ul close" id="mobile-toc-button" title="Table of Contents" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="Back to top" aria-hidden="true"></i></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@latest/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/lazysizes@latest/lazysizes.min.js" async=""></script></body></html>